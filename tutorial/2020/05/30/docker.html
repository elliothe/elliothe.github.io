<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ICRG @ Shanghai Jiao Tong University - Docker configuration</title>
  <meta name="description" content="step-by-step about the docker setup.">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="/tutorial/2020/05/30/docker.html">
  <!-- <link rel="shortcut icon" type ="image/x-icon" href="/images/favicon.ico"> -->
  <link rel="shortcut icon" type ="image/x-icon" href="/images/logo/sjtu_square_logo.ico">
  <script src="https://kit.fontawesome.com/a24320d871.js" crossorigin="anonymous"></script>



</head>





  <body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container-fluid">
	<div class="navbar-header">
	  <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1" aria-expanded="false">
		<span class="sr-only">Toggle navigation</span>
		<span class="icon-bar"></span>
		<span class="icon-bar"></span>
		<span class="icon-bar"></span>
	  </button>

    <a class="navbar-brand" href="/">ICRG @ Shanghai Jiao Tong University</a>
	</div>
	<div class="collapse navbar-collapse" id="navbar-collapse-1">
	  <ul class="nav navbar-nav navbar-right">
		<li><a href="/">Home</a></li>
		<li><a href="/people">People</a></li>
		<li><a href="/news">News</a></li>
		<li><a href="/blog">Blog</a></li>
		<li><a href="/research">Research</a></li>
		<li><a href="/publications">Publications</a></li>
	  </ul>
	</div>
  </div>
</div>


    <div class="container-fluid">
      <div class="col-sm-12">
        <div class="row">
          <div class="row">
    <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/blog">Blog</a></li>
        <li class="breadcrumb-item text-capitalize"><a href="/blog#tutorial">tutorial</a></li>
        <li class="breadcrumb-item active" aria-current="page">Docker configuration</li>
    </ol>
    </nav>
</div>


<div class="post-image-feature">
  <img class="feature-image" src="https://i1.wp.com/e4developer.com/wp-content/uploads/2018/01/vm-vs-docker.png" alt="Docker configuration feature image" style="max-width: 500px;">

  
</div>
<!-- /.image-wrap -->



<div id="post">
  <header class="post-header">
    <h2 title="Docker configuration">Docker configuration</h2>
    <span class="post-meta">
      <span class="post-date">
        30 MAY 2020
      </span>
      •
      <span class="read-time" title="Estimated read time">
    
    
      5 mins read
    
  </span>
    </span>
  </header>

  <!-- add dummy space -->
  <hr>
  <p></p> 

  <article class="post-content">
    <p>To ensure the code can efficiently be trained on servers. Here I create a docker image.</p>

<h2 id="system-configruation">System configruation</h2>

<p>Linux dist: Ubuntu 16.4
Nvidia-driver: 384/387
Cuda version: V9.0
Cudnn version: V7
Pytorch: <a href="https://pytorch.org/get-started/previous-versions/">v1.1.0</a> (highest version still support cuda v.9.0)</p>

<h2 id="docker-install">Docker install</h2>
<p>A complete docker tutorial can be found at <a href="https://docs.docker.com/engine/install/">docker</a> and <a href="https://docs.docker.com/engine/install/ubuntu/">docker engine</a> on ubuntu.</p>

<h3 id="1-configurations">1. configurations</h3>

<p>update <code class="language-plaintext highlighter-rouge">apt</code> packages</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt-get update
<span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="se">\</span>
    apt-transport-https <span class="se">\</span>
    ca-certificates <span class="se">\</span>
    curl <span class="se">\</span>
    gnupg-agent <span class="se">\</span>
    software-properties-common
</code></pre></div></div>

<p>Yo may get the curl error <code class="language-plaintext highlighter-rouge">curl : Depends: libcurl3-gnutls (= 7.47.0-1ubuntu2) but 7.47.0-1ubuntu2.7 is to be installed</code>, which may caused by the dependance issue between <code class="language-plaintext highlighter-rouge">curl</code> and <code class="language-plaintext highlighter-rouge">libcurl</code>. A quick fix is purge the libcurl:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt-get purge  libcurl3-gnutls
<span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>curl
</code></pre></div></div>

<p>Add docker GPG keys:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg | <span class="nb">sudo </span>apt-key add -
<span class="nv">$ </span><span class="nb">sudo </span>apt-key fingerprint 0EBFCD88 <span class="c">#fingerprint verification</span>
</code></pre></div></div>
<p>use the following command shows the linux distribution:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>lsb_release <span class="nt">-cs</span> 
<span class="o">&gt;</span> xenial <span class="c"># dist of ubuntu 16.4</span>
</code></pre></div></div>
<p>then add the <code class="language-plaintext highlighter-rouge">stable</code> repo:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>add-apt-repository <span class="se">\</span>
   <span class="s2">"deb [arch=amd64] https://download.docker.com/linux/ubuntu </span><span class="se">\</span><span class="s2">
   </span><span class="si">$(</span>lsb_release <span class="nt">-cs</span><span class="si">)</span><span class="s2"> </span><span class="se">\</span><span class="s2">
   stable"</span>
</code></pre></div></div>

<blockquote>
  <p>make sure you use [arch=amd64] above instead of x86_64 even if the system info shows x86_64.</p>
</blockquote>

<h3 id="2-install-docker">2. Install docker.</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span><span class="nb">sudo </span>apt-get update
 <span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>docker-ce docker-ce-cli containerd.io
</code></pre></div></div>

<blockquote>
  <p>new dependance error may raise.</p>
  <pre><code class="language-txt"> containerd.io : Depends: libseccomp2 (&gt;= 2.4.0) but 2.2.3-3ubuntu3 is to be installed
 docker-ce : Depends: libseccomp2 (&gt;= 2.3.0) but 2.2.3-3ubuntu3 is to be installed
</code></pre>
  <p>both the <code class="language-plaintext highlighter-rouge">containered.io</code> and <code class="language-plaintext highlighter-rouge">docker-ce</code> have the dependace on <code class="language-plaintext highlighter-rouge">libseccomp2</code>. The <code class="language-plaintext highlighter-rouge">docker-ce</code> one can be addressed <a href="https://stackoverflow.com/a/53481527">suggestion</a>:</p>
  <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>add-apt-repository ppa:ubuntu-sdk-team/ppa
<span class="nv">$ </span><span class="nb">sudo </span>apt-get update
</code></pre></div>  </div>
  <p>However, the <code class="language-plaintext highlighter-rouge">containered.io</code> dependency problem still remains:</p>
  <pre><code class="language-txt">containerd.io : Depends: libseccomp2 (&gt;= 2.4.0) but 2.3.1-2ubuntu2~ubuntu16.04.1~ppa1 is to be installed
</code></pre>
  <p>To address that, the only feasible solution is to manually update the <a href="https://packages.ubuntu.com/xenial/libseccomp2">package</a>. The installation follows the <a href="https://packages.ubuntu.com/xenial/amd64/libseccomp2/download">suggestion</a>:</p>
  <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nano /etc/apt/sources.list
</code></pre></div>  </div>
  <p>then add the following line to the above <code class="language-plaintext highlighter-rouge">sources.list</code> file:</p>
  <pre><code class="language-txt">deb http://security.ubuntu.com/ubuntu xenial-security main 
</code></pre>
  <p>then don’t forget the update:</p>
  <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt-get update
</code></pre></div>  </div>
</blockquote>

<h3 id="3-verify-the-installation-by-hello-world-docker-image">3. verify the installation by “hello-world” docker image.</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>docker run hello-world
</code></pre></div></div>

<p>The docker version can be checked by:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker version
</code></pre></div></div>

<h3 id="4-allow-non-sudo-user-use-docker">4. Allow non-sudo user use docker</h3>

<blockquote>
  <p>more details can be found at <a href="https://docs.docker.com/engine/install/linux-postinstall/">docker</a></p>
</blockquote>

<p>Due to the bind between docker daemon and unix socket (owned by root user and granted access by sudo), you can create docker group specifically for members not on the sudo-list.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>groupadd docker <span class="c">#create docker group</span>
<span class="nv">$ </span><span class="nb">sudo </span>usermod <span class="nt">-aG</span> docker <span class="nv">$USER</span> <span class="c"># add current USER to the docker group</span>
<span class="nv">$ </span>newgrp docker <span class="c"># activate the group change, relog the account if not work.</span>
</code></pre></div></div>

<h2 id="nvidia-container-toolkit-aka-nvidia-docker">NVIDIA Container toolkit (aka. nvidia-docker)</h2>

<h3 id="install">install</h3>
<p>As described in their <a href="https://github.com/NVIDIA/nvidia-docker">repo</a>, install the nvidia docker on ubuntu:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Add the package repositories</span>
<span class="nv">distribution</span><span class="o">=</span><span class="si">$(</span><span class="nb">.</span> /etc/os-release<span class="p">;</span><span class="nb">echo</span> <span class="nv">$ID$VERSION_ID</span><span class="si">)</span>
curl <span class="nt">-s</span> <span class="nt">-L</span> https://nvidia.github.io/nvidia-docker/gpgkey | <span class="nb">sudo </span>apt-key add -
curl <span class="nt">-s</span> <span class="nt">-L</span> https://nvidia.github.io/nvidia-docker/<span class="nv">$distribution</span>/nvidia-docker.list | <span class="nb">sudo tee</span> /etc/apt/sources.list.d/nvidia-docker.list

<span class="nb">sudo </span>apt-get update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> nvidia-container-toolkit
<span class="nb">sudo </span>systemctl restart docker
</code></pre></div></div>

<h3 id="usage">Usage</h3>

<blockquote>
  <p><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"><strong>CUDA version</strong>: the CUDA version highly depends on the NVIDIA GPU driver version. Here I use cuda:9.0.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#### Test nvidia-smi with the latest official CUDA image</span>
docker run <span class="nt">--gpus</span> all nvidia/cuda:9.0-base nvidia-smi

<span class="c"># Start a GPU enabled container on two GPUs</span>
docker run <span class="nt">--gpus</span> 2 nvidia/cuda:9.0-base nvidia-smi

<span class="c"># Starting a GPU enabled container on specific GPUs</span>
docker run <span class="nt">--gpus</span> <span class="s1">'"device=1,2"'</span> nvidia/cuda:9.0-base nvidia-smi
docker run <span class="nt">--gpus</span> <span class="s1">'"device=UUID-ABCDEF,1"'</span> nvidia/cuda:9.0-base nvidia-smi

<span class="c"># Specifying a capability (graphics, compute, ...) for my container</span>
<span class="c"># Note this is rarely if ever used this way</span>
docker run <span class="nt">--gpus</span> all,capabilities<span class="o">=</span>utility nvidia/cuda:9.0-base nvidia-smi
</code></pre></div></div>

<h2 id="build-and-run-your-image">Build and run your image</h2>

<blockquote>
  <p>more details can be found at docker <a href="https://docs.docker.com/get-started/">get-start</a></p>
</blockquote>

<h2 id="docker-hub">docker hub</h2>

<p>docker hub account login:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker login
</code></pre></div></div>

<h2 id="docker-image-build">docker image build</h2>

<p>The <code class="language-plaintext highlighter-rouge">./Dockerfile</code> is used for configure the docker image to be builded. Note that, to minimize the docker image size, the multi-stage build is used. Run following bash script for docker image build:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bash ./docker_build.sh
</code></pre></div></div>

<p>To better manage the python packages, you can use <code class="language-plaintext highlighter-rouge">requirements.txt</code> in the <code class="language-plaintext highlighter-rouge">Dockerfile</code>. Note that, the dependancies defined in <code class="language-plaintext highlighter-rouge">requirements.txt</code> can be install by conda-compatible pip.</p>

<p>Some more descriptions can be found <a href="https://jpetazzo.github.io/2013/12/01/docker-python-pip-requirements/">here</a></p>

<h2 id="share-docker-images-on-docker-hub">share docker images on Docker Hub</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker login
<span class="nv">$ </span>docker push &lt;docker-id&gt;/&lt;repository-name&gt;:&lt;tag&gt;
<span class="c"># docker push elliothe/pytorch:1.1</span>
</code></pre></div></div>

<h2 id="docker-container-run">docker container run</h2>

<p>In order to let the code running with the container as the development platform, the code the is mounted via the docker volume approach.</p>

  </article>
</div>

<!-- <div class="share-buttons">
  <h6>Share on: </h6>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=/tutorial/2020/05/30/docker.html" class="twitter btn" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=/tutorial/2020/05/30/docker.html" class="facebook btn" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=/tutorial/2020/05/30/docker.html" class="google-plus btn" title="Share on Google Plus"><i class="fa fa-google-plus"></i><span> Google+</span></a>
    </li>
    <li>
      <a href="https://www.reddit.com/submit?url=/tutorial/2020/05/30/docker.html" class="reddit btn" title="Share on Reddit"><i class="fa fa-reddit"></i><span> Reddit</span></a>
    </li>
  </ul>
</div> -->
<!-- end share-buttons -->



        </div>
      </div>
    </div>

    <div id="footer" class="panel">
  <div class="panel-footer">
	<div class="container-fluid">
		<div class="row">
			<div class="col-sm-4">
				<!-- <p>ICRG@SJTU</p> -->
				<div class="text-center">
					<!-- <img class="img-fluid" src="/images/logo/lab-logo.png"
					 style="max-width: 100px;"> -->
					<!-- <p></p> 
					<img class="img-fluid" src="/images/logo/SJTU_logo_red.png"
					 style="max-width: 275px;"> -->
					<p style="width: 250px;">
						<!-- <script type="text/javascript" id="clustrmaps" src="//clustrmaps.com/map_v2.js?d=cZgyhvWI7eq-9SnsSsJVkhMVioGtOr0YJqI3-Ejt9C8&cl=ffffff&w=a"></script> -->
						<script type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?cl=080808&amp;w=a&amp;t=tt&amp;d=cZgyhvWI7eq-9SnsSsJVkhMVioGtOr0YJqI3-Ejt9C8&amp;co=ffffff&amp;cmo=3acc3a&amp;cmn=ff5353&amp;ct=808080"></script>
					</p>
				</div>
				<!-- <p>ICRG@SJTU is currently at Department of Computer Science and Engineering at Shanghai Jiao Tong University</p> -->
			</div>

			<div class="col-sm-4">
				<p>Links</p>
				<ul class="list-unstyled">
					<li><a href="/vacancies">Vacancies</a></li>
					<li><a href="https://github.com/ericdaat/research-lab-website">Website template</a></li>
					<!-- <li><a href="">Link</a></li>
					<li><a href="">Link</a></li> -->
				</ul>
			</div>

			<div class="col-sm-4">
				<p>Contact</p>
				<p><a href="mailto:zhezhi.he@sjtu.edu.cn"><i class="fas fa-paper-plane"></i></a> zhezhi.he at sjtu dot edu dot cn</p>
				<p><a href="https://j.map.baidu.com/fc/Sil"><i class="fas fa-map-marked-alt"></i></a> 800 DongChuan Road, SEIEE Building #03-501, Minhang District, Shanghai  </p>
			</div>
		</div>

		<div class="row mt-3">
			<p class="text-center">
				© 2021 ICRG@SJTU. Powered by <a href="http://jekyllrb.com/">Jekyll</a> and <a href="https://getbootstrap.com/">bootstrap</a>.
			</p>
			<!-- <p class="text-center">Copyright, 2019</p> -->
		</div>

		<div>
			<p class="text-center">
			<img class="img-fluid" src="/images/logo/SJTU_logo_red.png" style="max-width: 275px;">
			</p>
		</div>

	</div>
  </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="/js/bootstrap.min.js"></script>


  </body>

</html>
